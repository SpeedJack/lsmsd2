[{$match: {
  market: 'COINBASE:BTC-USD'
}}, {$sort: {
  start: 1
}}, {$project: {
  _id: 0,
  ncandles: 0,
  'candles.h': 0,
  'candles.v': 0,
  'candles.l': 0,
  'candles.o': 0
}}, {$group: {
  _id: '$market',
  candles: {
    $push: '$candles'
  }
}}, {$addFields: {
  candles: {
    $reduce: {
      input: '$candles',
      initialValue: [],
      'in': {
        $concatArrays: [
          '$$value',
          '$$this'
        ]
      }
    }
  }
}}, {$addFields: {
  candles: {
    $map: {
      input: {
        $range: [1,{$size: '$candles'}]
      },
      as: 'z',
      'in': {
        momentum: {
          $subtract: [{$arrayElemAt: [
              "$candles.c",
              "$$z"
           ]}, 
           {$arrayElemAt: ["$candles.c", {$subtract:["$$z",1]}] }]

                  },
        t: {
          $arrayElemAt: [
            '$candles.t',
            "$$z"
          ]
        }
      }
    }
  }
}}]
