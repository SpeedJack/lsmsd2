[{$match: {
  market: 'COINBASE:ETH-EUR'
}}, {$sort: {
  start: 1
}}, {$unwind: {
  path: '$candles'
}}, {$replaceRoot: {
  newRoot: '$candles'
}}, {$addFields: {
  n: {
    $floor: {
      $divide: [
        {
          $subtract: [
            '$t',
            ISODate('1970-01-01T00:00:00.000Z')
          ]
        },
        1200000
      ]
    }
  }
}}, {$group: {
  _id: '$n',
  t: {
    $first: '$t'
  },
  o: {
    $first: '$o'
  },
  h: {
    $max: '$h'
  },
  l: {
    $min: '$l'
  },
  c: {
    $last: '$c'
  },
  v: {
    $sum: '$v'
  }
}}, {$project: {
  _id: 0
}}, {$sort: {
  t: 1
}}, {$group: {
  _id: null,
  "candles": {
    $push: "$$ROOT"
  }
}}, {$addFields: {
  "candles":{
    $map:{
      input:"$candles",
      as: "candle",
      in: {
        t: "$$candle.t",
        u: {$max: [{$subtract:["$$candle.c","$$candle.o"]},0]},
        d: {$max: [{$subtract:["$$candle.o","$$candle.c"]},0]}
      }
    }
  }
}}, {$addFields: {
  "candles": 
    {
      $map:
      {
        input: {$range:[0, {$subtract: [{$size: "$candles"}, 1]}]},
        as: "z",
        in: {
          t: "$$z.t",
          SMAu: {$avg: {$slice: ["$candles.u", "$$z", 20]}}
        }
      }
    }
}}]
