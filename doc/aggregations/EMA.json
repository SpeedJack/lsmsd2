
[{$match: {"market": "COINBASE:BTC-USD"}}, {$sort: {
  start: 1
}}, {$project: {
  _id: 0,
  ncandles: 0,
  "candles.h":0,
  "candles.v":0,
  "candles.l":0,
  "candles.o":0
}}, {$group: {
  _id: "$market",
  "candles":
  {
    $push: "$candles"
  }
}}, {$addFields: {
  "candles": 
  {
    $reduce:
    {
      input:"$candles",
      initialValue:[],
      in:{$concatArrays:["$$value","$$this"]}
    }
  }
}}, {$addFields: {
  "candles": 
    {
      $reduce: 
      {
        input: "$candles",
        initialValue: {total:{$arrayElemAt: ["$candles.c", 0]},d:[]},
        in: {
       	 total: {$sum: [{$multiply: ["$$this.c", 0.75]},{$multiply: ["$$value.total", 0.25]}]},
       	 d: {$concatArrays : [
                        "$$value.d",
                        [{
                            _id: "$$this.t",
                            c : "$$this.c",
                            EMA : {$sum: [{$multiply: ["$$this.c", 0.75]},{$multiply: ["$$value.total", 0.25]}]}  
                        }]
             ]}
	    }
      }
    }
}}, {$unwind: {
  path: "$candles.d"
}}, {$replaceRoot: {
  newRoot: "$candles.d"
}}]
