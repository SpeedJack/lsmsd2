
[{$match: {"market": "COINBASE:BTC-USD"}}, {$sort: {
  start: 1
}}, {$project: {
  _id: 0,
  ncandles: 0,
  "candles.h":0,
  "candles.v":0,
  "candles.l":0
}}, {$group: {
  _id: "$market",
  "candles":
  {
    $push: "$candles"
  }
}}, {$addFields: {
  "candles": 
  {
    $reduce:
    {
      input:"$candles",
      initialValue:[],
      in:{$concatArrays:["$$value","$$this"]}
    }
  }
}}, {$addFields: {
  "candles":{
    $map:{
      input:"$candles",
      as: "candle",
      in: {
        t: "$$candle.t",
        u: {$max: [{$subtract:["$$candle.c","$$candle.o"]},0]},
        d: {$max: [{$subtract:["$$candle.o","$$candle.c"]},0]}
      }
    }
  }
}}, {$addFields: {
  "candles": 
    {
      $reduce: 
      {
        input: "$candles",
        initialValue: {totalu:{$arrayElemAt: ["$candles.u", 0]}, totald:{$arrayElemAt: ["$candles.d", 0]}, d:[]},
        in: {
       	 totalu: {$sum: [{$multiply: ["$$this.u", 0.75]},{$multiply: ["$$value.totalu", 0.25]}]},
       	 totald: {$sum: [{$multiply: ["$$this.d", 0.75]},{$multiply: ["$$value.totald", 0.25]}]},
       	 d: {$concatArrays : [
                        "$$value.d",
                        [{
                            _id: "$$this.t",
                            u : "$$this.u",
			    d : "$$this.d", 
                            EMAu : {$sum: [{$multiply: ["$$this.u", 0.75]},{$multiply: ["$$value.totalu", 0.25]}]},
                            EMAd : {$sum: [{$multiply: ["$$this.d", 0.75]},{$multiply: ["$$value.totald", 0.25]}]}  
                        }]
             ]}
	    }
      }
    }
}}, {$unwind: {
  path: "$candles.d"
}}, {$replaceRoot: {
  newRoot: "$candles.d"
}}]