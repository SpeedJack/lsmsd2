\section{Collections}\label{sec:collections}

In this section we will define the database structure. The following collections
are defined:
\begin{enumerate*}[label=]
	\item \code{Users};
	\item \code{AuthTokens};
	\item \code{Sources};
	\item \code{MarketData};
	\item \code{Strategies}.
\end{enumerate*}

\subsection{Users}

\lstinputlisting[language=json, label={lst:userscollection},
caption={\code{Users} collection example.}]{users.json}

Each document represents a user.

Fields' description:
\begin{description}
	\item[\_id] \textit{(string)} Username;
	\item[passwordHash] \textit{(string)} Password hash;
	\item[isAdmin] \textit{(boolean, optional)} Specifies whether the user
		is the administrator or not; if not present, is considered
		\code{false};
\end{description}

\subsection{AuthTokens}

\lstinputlisting[language=json, label={lst:authtokenscollection},
caption={\code{AuthTokens} collection example.}]{authtokens.json}

Each document represents an authorization token used to authenticate the user
with the server. Multiple clients can connect as the same user creating a
session (a token) for each client (this allows for a session management feature
to be implemented in future).

Fields' description:
\begin{description}
	\item[\_id] \textit{(string)} Token hash (generated randomly);
	\item[username] \textit{(string)} User's username;
	\item[isAdmin] \textit{(boolean, optional)} Specifies whether the user
		is the administrator or not; if not present, is considered
		\code{false};
	\item[expireTime] \textit{(timestamp)} Token expire time.
\end{description}

\subsection{Sources}

\lstinputlisting[language=json, label={lst:sourcescollection},
caption={\code{Sources} collection example.}]{sources.json}

Each document represents a data source.

Fields' description:
\begin{description}
	\item[\_id] \textit{(string)} Source name;
	\item[enabled] \textit{(boolean, optional)} Specifies if the market is
		enabled or not. If not present, is considered \code{false};
	\item[markets] \textit{(array, optional)} array of embedded documents
		that lists the market available for this source. The structure
		of these documents is the following:
		\begin{description}
			\item[id] \textit{(string)} Name of the market;
			\item[baseCurrency] \textit{(string)} Name of the quoted
				currency;
			\item[quoteCurrency] \textit{(string)} Name of the
				quoting currency;
			\item[granularity] \textit{(integer)} Minimum size,
				in minutes, of a candle;
%			\item[firstMonthAvailable] \textit{(string, optional)}
%				Specifies the first month for which data is
%				available. If not present, is considered as no
%				data is available \idest{no data has been
%				downloaded yet};
			\item[selectable] \textit{(boolean, optional)} Specifies
				if users are allowed or not to test strategies
				on this market. If not present, is considered
				\code{false}. If \code{enabled} is \code{false},
				this is considered \code{false};
			\item[sync] \textit{(boolean, optional)} Specifies if
				the scraper should synchronize the data for this
				market with the data that it downloads from the
				source. If not present, is considered
				\code{false}. If \code{enabled} is \code{false},
				this is considered \code{false};
			\item[filled] \textit{(boolean, optional)} Specifies if
				the scraper has finished the download of old
				data for this market or not. If not present, is
				considered \code{false}.
		\end{description}
\end{description}

\subsection{MarketData}

\lstinputlisting[language=json, label={lst:marketdatacollection},
caption={\code{MarketData} document example.}]{marketdata.json}

Market data is divided into multiple documents, where each document represents a
month of data.

Fields' description:
\begin{description}
	\item[\_id] \textit{(string)} Format:
		\code{sourcename:marketname:YYYY-MM};
	\item[data] \textit{(array)} Array of embedded documents where each
		document represent a trading day (candle). The structure of
		these documents is the following:
		\begin{description}
			\item[t] \textit{(timestamp)} The closing time of the
				day;
			\item[o] \textit{(numeric)} The opening price of the
				day;
			\item[h] \textit{(numeric)} The highest price of the
				day;
			\item[l] \textit{(numeric)} The lowest price of the day;
			\item[c] \textit{(numeric)} The closing price of the
				day;
			\item[v] \textit{(numeric)} The volume, \idest*{the
				amount traded during the day}.
		\end{description}
\end{description}

The \code{data} array is pre-filled with all candles that should be part of the
month (even if not all candles are available). This improves performance when
the Scraper downloads the data from the source since it's a mutable document
that otherwise it will need to be frequently re-allocated.

\subsection{Strategies}

\lstinputlisting[language=json, label={lst:strategiescollection},
caption={\code{Strategy} document example.}]{strategies.json}

Each document represents a strategy.

Fields' description:
\begin{description}
	\item[\_id] \textit{(string)} Hash of the file that defines the
		strategy;
	\item[name] \textit{(string)} Name of the strategy;
	\item[author] \textit{(string)} Username of the user that submitted the
		strategy;
	\item[runs] \textit{(array, optional)} Array of embedded documents that
		list all the tests made by the users with this strategy. The
		structure of these documents is the following:
		\begin{description}
			\item[config] \textit{(document)} Strategy's
				configuration used:
				\begin{description}
					\item[hash] \textit{(string)} An hash
						that uniquely identifies the
						run configuration. If two
						configuration are equal, they
						should have the same hash;
					\item[market] \textit{(string)} Name of
						the market on which the strategy
						has been executed. Format:
						\enquote{sourcename:marketname};
					\item[granularity] \textit{(integer)}
						Size of candles passed to the
						strategy (this value should be a
						multiple of the minimum
						granularity of data available);
					\item[startTime]
						\textit{(timestamp)} Time of the
						first data on which the strategy
						has been executed;
					\item[endTime]
						\textit{(timestamp)} Time of the
						last data on which the strategy
						has been executed;
					\item[\ldots] Other fields may be
						present (defined by the
						strategy).
				\end{description}
			\item[report] \textit{(document)} Report generated by
				the execution of the strategy:
				\begin{description}
					\item[netProfit] \textit{(numeric)} The
						profit (\(\interval[open
						right]{0}{+\infty}\)) or loss
						(\(\interval[open
						right]{-1}{0}\)) of the
						strategy, computed as the total
						profit minus the total loss of
						the trades (percentage of the
						initial amount);
					\item[maxDrawback] \textit{(numeric)}
						The maximum drawback as defined
						in \chref{ch:specs}. This is
						expressed as a percentage of the
						initial amount;
					\item[hodlProfit] \textit{(numeric)} The
						profit (\(\interval[open
						right]{0}{+\infty}\)) or loss
						(\(\interval[open
						right]{-1}{0}\)) of the Buy and
						Hold strategy (percentage of the
						initial amount).
					\item[trades] \textit{(array, optional)}
						Array of embedded documents that
						describes the transactions made
						by the strategy. The structure
						of these documents is the
						following:
						\begin{description}
							\item[entryTime]
								\textit{(timestamp)}
								The time at
								which the trade
								is initiated;
							\item[exitTime]
								\textit{(timestamp,
								optional)}
								The time at
								which the trade
								is concluded
								(not present if
								the trade is
								still open);
							\item[amount]
								\textit{(numeric)}
								The amount of
								asset traded.
								This is a value
								between 0 and 1
								(percentage of
								the initial
								amount);
							\item[profit]
								\textit{(numeric,
								optional)} The
								profit
								(\(\interval[open
								right]{0}{+\infty}\))
								or the loss
								(\(\interval[open
								right]{-1}{0}\))
								of the trade,
								expressed as a
								percentage of
								the traded
								amount (not
								present if the
								trade is still
								open).
						\end{description}
				\end{description}
		\end{description}
\end{description}

The \code{report} document structure may be changed in future: some of its
fields are redundancies that may be computed by aggregating the \code{trades}
array\footnote{See \secref{sec:aggregations}.}. We will decide in future if
those redundancies are worth to maintain or not and if other redundancies should
be added.
