\section{Aggregation Pipelines}\label{sec:aggregations}

The following \standout{Aggregation Pipelines} has been defined:

\begin{itemize}
	\item To obtain a larger granularity on the data present in a given
		market, when we apply a strategy, we can aggregate the
		documents contained in the \code{data} array in the
		\code{MarketData} collection:
		\begin{enumerate}
			\item \code{\$match} stage to get the document
				containing the data for the specific market and
				the current month. This stage includes the
				entire shard key, so it is directed only to the
				specific server where the shard containing the
				document is saved;
			\item \code{\$project} stage to exclude the \code{\_id}
				field, no longer needed;
			\item \code{\$unwind} stage to extract the documents in
				the \code{data} field;
			\item \code{\$bucket} stage to aggregate multiple
				documents based on ranges of the \code{t} field.
		\end{enumerate}
	\item The server needs to know what is the first month for which data is
		available for a specific market, in order to run a query on that
		market. The following pipeline on the \code{MarketData}
		collection is defined:
		\begin{enumerate}
			\item \code{\$match} stage selects all documents for a
				specific market;
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed;
			\item \code{\$sort} stage to sort all documents by
				\code{\_id};
			\item \code{\$group} stage to get the value of the
				\code{\_id} field of the first document.
		\end{enumerate}
	\item At the start, the scraper needs to know the
		first and last month for which data is available for each
		market, in order to determine the range of data already
		available and restart downloading the data that is outside of
		this range. The following pipeline on the \code{MarketData}
		collection, similar to the previous one, is defined:
		\begin{enumerate}
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed. Moreover, in this stage, the
				\code{\_id} field is split into two fields: the
				first (\code{market}) contains the source name
				concatenated with the market name; the second
				(\code{month}) contains the string representing
				the year and the month;
			\item \code{\$sort} stage to sort all documents by
				\code{month};
			\item \code{\$group} stage to aggregate all documents
				by the same \code{market} and get the first and
				last document for each market;
			\item \code{\$poject} stage to output only the needed
				values (the first and last month).
		\end{enumerate}
	\item Further aggregations may be defined in future. In particular,
		other aggregations probably may be needed during the development
		of the functions used by strategies to get statistics over the
		market data. Moreover, during the development of the
		application, the need for other aggregations may arise.
\end{itemize}

Note that, during the development of the application, the above pipelines may be
implemented in some other way \exgratia{different stages or in different order}
in order to improve the performance of the queries.

\subsection{Indicators}

The following aggregation pipelines has been defined to compute some indicators
that are commonly used in technical analysis of financial market.

\begin{itemize}
	\item Simple Moving Average (SMA): arithmetic moving average calculated
		by adding recent closing prices and then dividing that by the
		number of time periods in the calculation average. The following
		pipeline on the \code{MarketData} collection is defined:
		\begin{enumerate}
			\item \code{\$match} stage selects all documents for a
				specific market;
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed;
			\item \code{\$sort} stage to sort all documents by
				\code{start};
			\item \code{\$group} and \code{\$addFields} stages to
				put together all the candles of a given market.
			\item \code{\$addFields} to compute the SMA on the whole
				array using \code{\$map} and \code{\$reduce}
				operators.
		\end{enumerate}
	\item Exponential Moving Average (EMA): a type of moving average that
		places a greater weight and significance on the most recent data
		points. The following pipeline on the \code{MarketData}
		collection is defined:
		\begin{enumerate}
			\item \code{\$match} stage selects all documents for a
				specific market;
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed;
			\item \code{\$sort} stage to sort all documents by
				\code{start};
			\item \code{\$group} and \code{\$addFields} stages to
				put together all the candles of a given market.
			\item \code{\$addFields} to compute the EMA on the whole
				array using \code{\$map} and \code{\$reduce}
				operators.
			\item \code{\$unwind} and \code{\$replaceRoot} to format
				the document in a more manageable way.
		\end{enumerate}
	\item Relative Strength (RS):a momentum indicator that measures the
		magnitude of recent price changes to evaluate overbought or
		oversold conditions in the price of a stock or other asset. The
		following pipeline on the \code{MarketData} collection is
		defined:
		\begin{enumerate}
			\item \code{\$match} stage selects all documents for a
				specific market;
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed;
			\item \code{\$sort} stage to sort all documents by
				\code{start};
			\item \code{\$group} and \code{\$addFields} stages to
				put together all the candles of a given market.
			\item \code{\$addFields} to compute the RS on the whole
				array using \code{\$map} and \code{\$reduce}
				operators.
			\item \code{\$unwind} and \code{\$replaceRoot} to format
				the document in a more manageable way.
		\end{enumerate}
	\item Momentum (MOM): the rate of acceleration of asset's price, the
		speed at which the price is changing. The following pipeline on
		the \code{MarketData} collection is defined:
		\begin{enumerate}
			\item \code{\$match} stage selects all documents for a
				specific market;
			\item \code{\$project} stage to extract only the
				\code{\_id} field, since the \code{data} field
				is not needed;
			\item \code{\$sort} stage to sort all documents by
				\code{start};
			\item \code{\$group} and \code{\$addFields} stages to
				put together all the candles of a given market.
			\item \code{\$addFields} to compute the MOM on the whole
				array using \code{\$map} and \code{\$reduce}
				operators.
		\end{enumerate}
\end{itemize}
